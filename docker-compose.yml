# Sonántica - Docker Compose Configuration
# Philosophy: "User autonomy" - flexible volume mounting
#
# Hardware Optimization Stack:
# - CPU: AMD Ryzen 7 5700X (8 Cores / 16 Threads)
# - RAM: 48GB DDR4 3200MHz
# - GPU: NVIDIA GeForce GTX 1080 Turbo Asus (8GB GDDR5X, CUDA Support)
# - OS: Windows 10 Pro 21H2
# Usage:
#   Production:  docker compose up -d
#   Stop:        docker compose down

services:
  # ============================================
  # PERSISTENCE LAYER
  # ============================================
  postgres:
    # Use custom build context from data/psql (contains pgvector & init scripts)
    build:
      context: ./data/psql
      dockerfile: Dockerfile
    container_name: sonantica-postgres
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-sonantica}
      PSQL_PASSWORD: ${PSQL_PASSWORD:-sonantica}
      POSTGRES_DB: ${POSTGRES_DB:-sonantica}
      ENCODING: UTF8
    volumes:
      # Data persistence - Uses named volume for safety
      - postgres_data:/var/lib/postgresql/data
      - ./data/psql/init.d:/config
      - ./data/psql/logs:/var/log/postgresql
    networks:
      - sonantica-net
    command: [ "postgres", "-p", "${PSQL_PORT:-5432}" ]
    ports:
      - "127.0.0.1:${PSQL_PORT:-5432}:${PSQL_PORT:-5432}"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-sonantica} -p ${PSQL_PORT:-5432}" ]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      com.sonantica.description: "Primary Data Store"

  redis:
    # Use custom build context from data/redis (contains redis.conf)
    build:
      context: ./data/redis
      dockerfile: Dockerfile
    environment:
      TZ: ${TZ:-UTC}
      REDIS_HOST: redis
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-sonantica}
    container_name: sonantica-redis
    restart: always
    volumes:
      # Data persistence - Uses named volume for safety
      - redis_data:/data
      - ./data/redis/dump:/dump
      - ./data/redis/logs:/var/log/redis
    networks:
      - sonantica-net
    ports:
      - "127.0.0.1:${REDIS_PORT:-6379}:${REDIS_PORT:-6379}"
    command: [ "redis-server", "/usr/local/etc/redis/redis.conf", "--port", "${REDIS_PORT:-6379}", "--requirepass", "${REDIS_PASSWORD:-sonantica}" ]
    healthcheck:
      test: [ "CMD", "redis-cli", "-p", "${REDIS_PORT:-6379}", "-a", "${REDIS_PASSWORD:-sonantica}", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      com.sonantica.description: "Cache & Message Broker"

  # ============================================
  # CORE SERVICES (High Performance)
  # ============================================
  stream-core:
    build:
      context: ./services/go-core
      dockerfile: Dockerfile
    container_name: sonantica-core
    ports:
      - "${CORE_PORT:-8090}:8080"
    environment:
      - POSTGRES_URL=postgres://${POSTGRES_USER:-sonantica}:${PSQL_PASSWORD:-sonantica}@postgres:${PSQL_PORT:-5432}/${POSTGRES_DB:-sonantica}?sslmode=disable
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-sonantica}
      - MEDIA_PATH=/media
      - ANALYTICS_ENABLED=${ANALYTICS_ENABLED:-true}
      - ANALYTICS_RETENTION_DAYS=${ANALYTICS_RETENTION_DAYS:-90}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost,http://localhost:3000,http://localhost:5173,capacitor://localhost,http://192.168.100.6:3000,http://192.168.100.6:5173,http://192.168.100.6}
      # Logging Configuration
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=${LOG_FORMAT:-json}
      - LOG_ENABLED=${LOG_ENABLED:-true}
    volumes:
      - ${MEDIA_PATH:-./media}:/media:ro
      - ${BUCKETS_PATH:-./buckets}:/buckets:ro
      - ${MEDIA_PATH:-./media}:/media:ro
      - ./config:/config:ro
      - ./logs/core:/var/log/sonantica
      - sonantica_cache:/covers
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - sonantica-net
    labels:
      com.sonantica.description: "High-Performance Streaming & Analytics Core (Go)"
    user: root # Dev: Avoid permission issues with bind mounts
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

  audio-worker:
    build:
      context: ./services/python-worker
      dockerfile: Dockerfile
    container_name: sonantica-worker
    restart: unless-stopped
    environment:
      - POSTGRES_URL=postgres://${POSTGRES_USER:-sonantica}:${PSQL_PASSWORD:-sonantica}@postgres:${PSQL_PORT:-5432}/${POSTGRES_DB:-sonantica}?sslmode=disable
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-sonantica}
      - MEDIA_PATH=/media
      - PYTHONPATH=/app:/app/src
      # Logging Configuration
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=${LOG_FORMAT:-json}
      - LOG_ENABLED=${LOG_ENABLED:-true}
    volumes:
      - ${MEDIA_PATH:-./media}:/media:ro
      - ${BUCKETS_PATH:-./buckets}:/buckets:ro
      - ${MEDIA_PATH:-./media}:/media:ro
      - ./logs/worker:/var/log/sonantica
      - sonantica_cache:/covers
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - sonantica-net
    command: ["celery", "-A", "worker.app", "worker", "--loglevel=info", "-Q", "celery", "-c", "2", "-E"]
    labels:
      com.sonantica.description: "Audio Analysis & Analytics Worker (Celery)"
    user: root
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1024M
        reservations:
          cpus: '0.5'
          memory: 256M

  celery-beat:
    build:
      context: ./services/python-worker
      dockerfile: Dockerfile
    container_name: sonantica-beat
    restart: unless-stopped
    environment:
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-sonantica}
      - POSTGRES_URL=postgres://${POSTGRES_USER:-sonantica}:${PSQL_PASSWORD:-sonantica}@postgres:${PSQL_PORT:-5432}/${POSTGRES_DB:-sonantica}?sslmode=disable
      - PYTHONPATH=/app:/app/src
      # Logging Configuration
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=${LOG_FORMAT:-json}
      - LOG_ENABLED=${LOG_ENABLED:-true}
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - sonantica-net
    command: ["celery", "-A", "worker.app", "beat", "--loglevel=info"]
    labels:
      com.sonantica.description: "Periodic Task Scheduler (Celery Beat)"
    user: root

  flower:
    build:
      context: ./services/python-worker
      dockerfile: Dockerfile
    container_name: sonantica-flower
    restart: unless-stopped
    environment:
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-sonantica}
      - POSTGRES_URL=postgres://${POSTGRES_USER:-sonantica}:${PSQL_PASSWORD:-sonantica}@postgres:${PSQL_PORT:-5432}/${POSTGRES_DB:-sonantica}?sslmode=disable
      - PYTHONPATH=/app:/app/src
      # Logging Configuration
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=${LOG_FORMAT:-json}
      - LOG_ENABLED=${LOG_ENABLED:-true}
    ports:
      - "5555:5555"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - sonantica-net
    command: ["celery", "-A", "worker.app", "flower", "--port=5555", "--inspect-timeout=3000"]
    labels:
      com.sonantica.description: "Celery Task Monitor"
    user: root

  # ============================================
  # AI PLUGINS (Optional - Opt-in via --profile ai)
  # ============================================
  plugin-demucs:
    build:
      context: ./services/ai-plugins/demucs
      dockerfile: Dockerfile
    container_name: sonantica-plugin-demucs
    profiles: ["ai"] # Opt-in only - user must explicitly enable
    restart: unless-stopped
    environment:
      - TORCH_HOME=/model_cache/torch
      - HF_HOME=/model_cache/huggingface
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-sonantica}
      - MEDIA_PATH=/media
      - OUTPUT_PATH=/stems
      - MAX_CONCURRENT_JOBS=${AI_MAX_CONCURRENT_JOBS:-2}
      - JOB_TIMEOUT_SECONDS=${AI_JOB_TIMEOUT:-600}
      - INTERNAL_API_SECRET=${INTERNAL_API_SECRET:-generate-secure-token-here}
      # Logging Configuration
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=${LOG_FORMAT:-json}
      - LOG_ENABLED=${LOG_ENABLED:-true}
    volumes:
      - ${MEDIA_PATH:-./media}:/media:ro
      - sonantica_stems:/stems
      - sonantica_ai_cache:/model_cache # Critical for persistence
      - ./logs/ai/demucs:/var/log/sonantica
    networks:
      - sonantica-net
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "127.0.0.1:8091:8080" # Internal API for debugging
    labels:
      com.sonantica.description: "AI Stem Separation Plugin (Demucs)"
    user: root
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  plugin-brain:
    build:
      context: ./services/ai-plugins/brain
      dockerfile: Dockerfile
    container_name: sonantica-plugin-brain
    profiles: ["ai"]
    restart: unless-stopped
    environment:
      - TORCH_HOME=/model_cache/torch
      - HF_HOME=/model_cache/huggingface
      - POSTGRES_URL=postgres://${POSTGRES_USER:-sonantica}:${PSQL_PASSWORD:-sonantica}@postgres:${PSQL_PORT:-5432}/${POSTGRES_DB:-sonantica}?sslmode=disable
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-sonantica}
      - MEDIA_PATH=/media
      - EMBEDDING_MODEL=${AI_EMBEDDING_MODEL:-laion/clap-htsat-unfused}
      - EMBEDDING_DIMENSION=${AI_EMBEDDING_DIM:-512}
      - MAX_CONCURRENT_JOBS=${AI_MAX_CONCURRENT_JOBS:-2}
      - INTERNAL_API_SECRET=${INTERNAL_API_SECRET:-generate-secure-token-here}
      # Logging Configuration
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=${LOG_FORMAT:-json}
      - LOG_ENABLED=${LOG_ENABLED:-true}
    volumes:
      - ${MEDIA_PATH:-./media}:/media:ro
      - sonantica_ai_cache:/model_cache
      - ./logs/ai/brain:/var/log/sonantica
    networks:
      - sonantica-net
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "127.0.0.1:8092:8080" # Internal API for debugging
    labels:
      com.sonantica.description: "AI Audio Similarity Plugin (Brain)"
    user: root
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 6G
        reservations:
          cpus: '1.0'
          memory: 2G
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  plugin-knowledge:
    build:
      context: ./services/ai-plugins/knowledge
      dockerfile: Dockerfile
    container_name: sonantica-plugin-knowledge
    profiles: ["ai"]
    restart: unless-stopped
    environment:
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11434}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-sonantica}
      - POSTGRES_URL=postgres://${POSTGRES_USER:-sonantica}:${PSQL_PASSWORD:-sonantica}@postgres:${PSQL_PORT:-5432}/${POSTGRES_DB:-sonantica}?sslmode=disable
      - INTERNAL_API_SECRET=${INTERNAL_API_SECRET:-generate-secure-token-here}
      - CACHE_TTL_HOURS=${AI_KNOWLEDGE_CACHE_TTL:-168} # 7 days default
      # Logging Configuration
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=${LOG_FORMAT:-json}
      - LOG_ENABLED=${LOG_ENABLED:-true}
    volumes:
      - ./logs/ai/knowledge:/var/log/sonantica
    networks:
      - sonantica-net
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    ports:
      - "127.0.0.1:8093:8080" # Internal API for debugging
    labels:
      com.sonantica.description: "AI Knowledge Enrichment Plugin (Ollama Client)"
    user: root
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

  # ============================================
  # FRONTEND & PROXY
  # ============================================
  web:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: sonantica-web
    ports:
      - "${WEB_PORT:-3000}:80"
    volumes:
      - ${MEDIA_PATH:-./media}:/media:ro
      - ${BUCKETS_PATH:-./buckets}:/buckets:ro
      - ${MEDIA_PATH:-./media}:/media:ro
      - ${CONFIG_PATH:-./config}:/config:rw
    environment:
      - NODE_ENV=production
      - SONANTICA_VERSION=${SONANTICA_VERSION:-0.1.0}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=${LOG_FORMAT:-json}
      - LOG_ENABLED=${LOG_ENABLED:-true}
    restart: unless-stopped
    depends_on:
      - stream-core
    networks:
      - sonantica-net
    labels:
      com.sonantica.description: "Audio-first multimedia player"

  nginx-proxy:
    image: nginx:alpine
    container_name: sonantica-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx-proxy.conf:/etc/nginx/nginx.conf:ro
      - ./docker/ssl:/etc/nginx/ssl:ro
    depends_on:
      - web
    networks:
      - sonantica-net
    labels:
      com.sonantica.description: "Reverse proxy for Sonántica services"

networks:
  sonantica-net:
    driver: bridge
    name: sonantica-network

volumes:
  node_modules:
    driver: local
  shared_dist:
    driver: local
  core_dist:
    driver: local
  postgres_data:
    driver: local
  redis_data:
    driver: local
  sonantica_cache:
    driver: local
  # AI Plugin Volumes
  sonantica_ai_cache:
    driver: local
    # Stores downloaded AI models (Torch, HuggingFace)
    # Prevents re-downloading GBs on container restart
  sonantica_stems:
    driver: local
    # Stores separated audio stems (vocals, drums, bass, other)
